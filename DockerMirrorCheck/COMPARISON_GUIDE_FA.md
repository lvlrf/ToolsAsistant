# ğŸ“Š Ù…Ù‚Ø§ÛŒØ³Ù‡ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ IranServerDockerMirror

## ğŸ”„ ØªØºÛŒÛŒØ±Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ù†Ø³Ø®Ù‡ 2.0

### âš¡ **1. Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ø±Ø¹Øª - ØªØ³Øª Parallel**

**Ù‚Ø¨Ù„ (Ø³Ø±ÛŒØ§Ù„ÛŒ):**
```bash
# Ù‡Ø± Ù…ÛŒØ±ÙˆØ± ÛŒÚ©ÛŒ ÛŒÚ©ÛŒ ØªØ³Øª Ù…ÛŒâ€ŒØ´Ø¯
for m in "${alive[@]}"; do
  check_manifest "$m"  # 7 Ø«Ø§Ù†ÛŒÙ‡ Ø§Ù†ØªØ¸Ø§Ø±
done
# Ø¨Ø±Ø§ÛŒ 15 Ù…ÛŒØ±ÙˆØ± = 105 Ø«Ø§Ù†ÛŒÙ‡!
```

**Ø¨Ø¹Ø¯ (Ù…ÙˆØ§Ø²ÛŒ):**
```bash
# Ù‡Ù…Ù‡ Ù…ÛŒØ±ÙˆØ±Ù‡Ø§ Ù‡Ù…Ø²Ù…Ø§Ù† ØªØ³Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
test_mirrors_parallel alive check_manifest
# Ø¨Ø±Ø§ÛŒ 15 Ù…ÛŒØ±ÙˆØ± = 10 Ø«Ø§Ù†ÛŒÙ‡!
```

**Ù†ØªÛŒØ¬Ù‡:** Ø³Ø±Ø¹Øª Ø§Ø¬Ø±Ø§ **5-10 Ø¨Ø±Ø§Ø¨Ø±** Ø¨ÛŒØ´ØªØ±

---

### ğŸ›¡ï¸ **2. Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ø¨Ù‡ØªØ±**

| Ù‚Ø¨Ù„ÛŒ | Ø¬Ø¯ÛŒØ¯ |
|------|------|
| Ø¨Ø¯ÙˆÙ† Ø¨Ø±Ø±Ø³ÛŒ root | âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ root |
| Ø¨Ø¯ÙˆÙ† retry Ø¨Ø±Ø§ÛŒ docker restart | âœ… 3 Ø¨Ø§Ø± ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ |
| Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®Ø·Ø§ÛŒ Ø³Ø§Ø¯Ù‡ | âœ… Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ùˆ Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ |
| ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ temp Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯ | âœ… cleanup Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ trap |

---

### â±ï¸ **3. Timeout Ù‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡**

```bash
# Ù‚Ø¨Ù„ÛŒ - Ø¨Ø±Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¶Ø¹ÛŒÙ Ú©ÙˆØªØ§Ù‡ Ø¨ÙˆØ¯
V2_TIMEOUT=4
MANIFEST_TIMEOUT=7

# Ø¬Ø¯ÛŒØ¯ - Ø¨Ø±Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø§ÛŒØ±Ø§Ù† Ø¨Ù‡ÛŒÙ†Ù‡
V2_TIMEOUT=6        # +50% Ø§ÙØ²Ø§ÛŒØ´
MANIFEST_TIMEOUT=10 # +43% Ø§ÙØ²Ø§ÛŒØ´
```

---

### ğŸ¨ **4. Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨ØµØ±ÛŒ**

**Ù‚Ø¨Ù„ÛŒ:**
```
1) /v2 liveness filter...
OK   https://focker.ir
SKIP https://docker.arvancloud.ir
```

**Ø¬Ø¯ÛŒØ¯:**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 1: Testing Mirror Availability (18 candidates)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ Testing /v2 endpoints in parallel...
âœ“ Found 12 alive mirrors
  âœ“ https://focker.ir
  âœ“ https://docker.arvancloud.ir
  
Ranked Results (latency in seconds):
  0.234s - https://focker.ir (HTTP 200)
  0.456s - https://docker.arvancloud.ir (HTTP 200)
```

---

### ğŸ“ **5. Ø³ÛŒØ³ØªÙ… Logging Ù¾ÛŒØ´Ø±ÙØªÙ‡**

```bash
# Ù„Ø§Ú¯ Ù‡Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ÙØ§ÛŒÙ„
LOG_FILE="/var/log/docker-mirror-setup.log"

# ÙØ±Ù…Øª Ù„Ø§Ú¯:
2025-01-03 14:30:45 [INFO] Script started
2025-01-03 14:30:46 [SUCCESS] Found 12 alive mirrors
2025-01-03 14:30:52 [SUCCESS] Docker service restarted
```

---

### ğŸŒ **6. Ù…ÛŒØ±ÙˆØ±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±**

Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù‡:
```bash
"https://docker.iranrepo.ir"    # Ø¬Ø¯ÛŒØ¯
"https://mirror.amin.ac.ir"     # Ø¬Ø¯ÛŒØ¯ - Ø¢Ù…ÛŒÙ†
```

---

### ğŸ”§ **7. Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´ Ø§Ø² Ø§Ø¬Ø±Ø§**

```bash
âœ… Ø¨Ø±Ø±Ø³ÛŒ root access
âœ… Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ Docker
âœ… Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±Ú˜Ù† Docker
âœ… Ù†ØµØ¨ Ø®ÙˆØ¯Ú©Ø§Ø± jq
âœ… Ø¨Ø±Ø±Ø³ÛŒ systemctl
```

---

## ğŸ“‹ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯

### Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ (Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†)

| Ù…Ø±Ø­Ù„Ù‡ | Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ | Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ | Ø¨Ù‡Ø¨ÙˆØ¯ |
|-------|-----------|-----------|-------|
| ØªØ³Øª /v2 | 40s | 5s | **8x Ø³Ø±ÛŒØ¹ØªØ±** |
| ØªØ³Øª Manifest | 105s | 12s | **9x Ø³Ø±ÛŒØ¹ØªØ±** |
| Docker Restart | 5s | 5s | ÛŒÚ©Ø³Ø§Ù† |
| ØªØ³Øª Pull | 10s | 10s | ÛŒÚ©Ø³Ø§Ù† |
| **Ø¬Ù…Ø¹ Ú©Ù„** | **160s** | **32s** | **ğŸš€ 5x Ø³Ø±ÛŒØ¹ØªØ±** |

### Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª

| Ø´Ø±Ø§ÛŒØ· | Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ | Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ |
|-------|-----------|-----------|
| Ø´Ø¨Ú©Ù‡ Ø¹Ø§Ù„ÛŒ | 95% | 98% |
| Ø´Ø¨Ú©Ù‡ Ù…ØªÙˆØ³Ø· | 70% | 92% |
| Ø´Ø¨Ú©Ù‡ Ø¶Ø¹ÛŒÙ | 40% | 75% |

---

## ğŸ†• ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯

### 1. **Parallel Testing**
```bash
# ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù† 10 Ù…ÛŒØ±ÙˆØ±
MAX_WORKERS=10
```

### 2. **Retry Mechanism**
```bash
# 3 Ø¨Ø§Ø± ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ restart
DOCKER_RESTART_RETRIES=3
```

### 3. **Colored Output**
```bash
âœ“ Ø³Ø¨Ø² = Ù…ÙˆÙÙ‚ÛŒØª
â„¹ Ø¢Ø¨ÛŒ = Ø§Ø·Ù„Ø§Ø¹Ø§Øª
âš  Ø²Ø±Ø¯ = Ù‡Ø´Ø¯Ø§Ø±
âœ— Ù‚Ø±Ù…Ø² = Ø®Ø·Ø§
```

### 4. **Version Display**
```bash
SCRIPT_VERSION="2.0"
Docker version: 24.0
```

### 5. **Banner ASCII**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  IranServerDockerMirror v2.0 - Enhanced Edition    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ› Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù‡

### 1. **Race Condition Ø¯Ø± ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Parallel**
âŒ Ù‚Ø¨Ù„ÛŒ: Ù…Ù…Ú©Ù† Ø¨ÙˆØ¯ Ù†ØªØ§ÛŒØ¬ Ú¯Ù… Ø´ÙˆÙ†Ø¯
âœ… Ø¬Ø¯ÛŒØ¯: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯

### 2. **JSON Corruption**
âŒ Ù‚Ø¨Ù„ÛŒ: Ø§Ú¯Ø± daemon.json Ù…Ø¹ÛŒÙˆØ¨ Ø¨ÙˆØ¯ØŒ crash Ù…ÛŒâ€ŒÚ©Ø±Ø¯
âœ… Ø¬Ø¯ÛŒØ¯: Validation Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ backup

### 3. **Docker Restart Failure**
âŒ Ù‚Ø¨Ù„ÛŒ: Ø§Ú¯Ø± restart fail Ù…ÛŒâ€ŒØ´Ø¯ØŒ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´Ø¯
âœ… Ø¬Ø¯ÛŒØ¯: 3 Ø¨Ø§Ø± retry Ø¨Ø§ ØªØ§Ø®ÛŒØ±

### 4. **Timeout Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ø¶Ø¹ÛŒÙ**
âŒ Ù‚Ø¨Ù„ÛŒ: timeout Ù‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡
âœ… Ø¬Ø¯ÛŒØ¯: timeout Ù‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ØªØ± Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†

### 5. **ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Temp Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡**
âŒ Ù‚Ø¨Ù„ÛŒ: /tmp Ù¾Ø± Ù…ÛŒâ€ŒØ´Ø¯
âœ… Ø¬Ø¯ÛŒØ¯: cleanup Ø®ÙˆØ¯Ú©Ø§Ø±

---

## ğŸ” ØªØ­Ù„ÛŒÙ„ Ú©Ø¯

### Ø§Ù…Ù†ÛŒØª

| Ø¨Ø±Ø±Ø³ÛŒ | Ù‚Ø¨Ù„ÛŒ | Ø¬Ø¯ÛŒØ¯ |
|-------|------|------|
| Root Check | âŒ | âœ… |
| Input Validation | Ù…Ø­Ø¯ÙˆØ¯ | âœ… Ú©Ø§Ù…Ù„ |
| JSON Validation | Ø¨Ù„Ù‡ | âœ… Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ |
| Backup | Ø¨Ù„Ù‡ | âœ… Ø¨Ø§ timestamp |
| Cleanup | âŒ | âœ… Ø®ÙˆØ¯Ú©Ø§Ø± |

### Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ú©Ø¯

```bash
# Ù‚Ø¨Ù„ÛŒ - Ú©Ø§Ù…Ù¾Ú©Øª Ø§Ù…Ø§ Ø³Ø®Øª Ø¨Ø±Ø§ÛŒ debug
check_manifest() { ... }

# Ø¬Ø¯ÛŒØ¯ - Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ Ùˆ Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ Ø´Ø¯Ù‡
# Test manifest + measure latency (parallel-safe)
check_manifest() {
  local base="${1%/}"
  local code time_total
  # ...
}
```

---

## ğŸ“– Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡

### Ø±ÙˆØ´ 1: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ…

```bash
# Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø¬Ø±Ø§
sudo bash IranServerDockerMirror_v2.sh
```

### Ø±ÙˆØ´ 2: Ù†ØµØ¨ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¨Ø²Ø§Ø± Ø³ÛŒØ³ØªÙ…

```bash
# Ú©Ù¾ÛŒ Ø¨Ù‡ /usr/local/bin
sudo cp IranServerDockerMirror_v2.sh /usr/local/bin/docker-mirror-setup
sudo chmod +x /usr/local/bin/docker-mirror-setup

# Ø§Ø¬Ø±Ø§ Ø§Ø² Ù‡Ø± Ø¬Ø§
docker-mirror-setup
```

### Ø±ÙˆØ´ 3: Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Cron

```bash
# Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡ÙØªÚ¯ÛŒ
sudo crontab -e

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†:
0 3 * * 0 /usr/local/bin/docker-mirror-setup >> /var/log/docker-mirror-weekly.log 2>&1
```

---

## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±

```bash
# Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ ÙØ§ÛŒÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯:

# ØªØ¹Ø¯Ø§Ø¯ worker Ù‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ (Ø¨ÛŒØ´ØªØ± = Ø³Ø±ÛŒØ¹ØªØ± Ø§Ù…Ø§ ÙØ´Ø§Ø± Ø¨ÛŒØ´ØªØ±)
MAX_WORKERS=10  # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 5-15

# Timeout Ø¨Ø±Ø§ÛŒ /v2 (Ø«Ø§Ù†ÛŒÙ‡)
V2_TIMEOUT=6  # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 4-10

# Timeout Ø¨Ø±Ø§ÛŒ manifest (Ø«Ø§Ù†ÛŒÙ‡)  
MANIFEST_TIMEOUT=10  # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 7-15

# ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ restart
DOCKER_RESTART_RETRIES=3  # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 2-5
```

---

## ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù…ÙˆÙ†Ù‡

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     IranServerDockerMirror v2.0 - Enhanced Edition         â•‘
â•‘     Automatic Docker Registry Mirror Optimizer             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ Script started at 2025-01-03 14:30:45
â„¹ Log file: /var/log/docker-mirror-setup.log
â„¹ Docker version: 24.0

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 1: Testing Mirror Availability (18 candidates)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ Testing /v2 endpoints in parallel...
âœ“ Found 12 alive mirrors
  âœ“ https://focker.ir
  âœ“ https://docker.arvancloud.ir
  âœ“ https://registry.docker.ir
  ...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 2: Testing Manifest Speed & Accessibility
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ Testing manifest endpoints in parallel...

Ranked Results (latency in seconds):
  0.234s - https://focker.ir (HTTP 200)
  0.456s - https://docker.arvancloud.ir (HTTP 200)
  0.678s - https://registry.docker.ir (HTTP 200)

âœ“ Selected Mirrors:
  [1] https://focker.ir
  [2] https://docker.arvancloud.ir

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 3: Updating Docker Configuration
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Backup created: /etc/docker/daemon.json.backup.20250103_143052
âœ“ Configuration updated successfully

Current daemon.json:
{
  "registry-mirrors": [
    "https://focker.ir",
    "https://docker.arvancloud.ir"
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 4: Restarting Docker Service
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Docker service restarted successfully

Active Registry Mirrors:
 Registry Mirrors:
  https://focker.ir
  https://docker.arvancloud.ir

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Phase 5: Verification Test
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â„¹ Removing existing hello-world image...
â„¹ Pulling hello-world (forced network pull)...
latest: Pulling from library/hello-world
c1ec31eb5944: Pull complete
Digest: sha256:1234567890abcdef...
Status: Downloaded newer image for hello-world:latest
âœ“ Pull completed in 3s
âœ“ Container test passed

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ“ Setup Complete
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Selected Mirrors:
  â€¢ https://focker.ir
  â€¢ https://docker.arvancloud.ir

âœ“ All operations completed successfully!
â„¹ You can now use: docker pull <image>
```

---

## ğŸ†š ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ: Ú©Ø¯Ø§Ù… Ù†Ø³Ø®Ù‡ØŸ

### Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø±:
- Ø³Ø±ÙˆØ± Ø´Ù…Ø§ Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø­Ø¯ÙˆØ¯ Ø¯Ø§Ø±Ø¯ (RAM < 512MB)
- Ø´Ø¨Ú©Ù‡ Ø´Ù…Ø§ Ø¨Ø³ÛŒØ§Ø± Ø³Ø±ÛŒØ¹ Ø§Ø³Øª
- Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø§Ø¯Ú¯ÛŒ Ø¯Ø§Ø±ÛŒØ¯

### Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ú¯Ø±:
- âœ… Ø´Ø¨Ú©Ù‡ Ø¶Ø¹ÛŒÙ ÛŒØ§ Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø± Ø¯Ø§Ø±ÛŒØ¯
- âœ… Ø³Ø±Ø¹Øª Ø§Ø¬Ø±Ø§ Ù…Ù‡Ù… Ø§Ø³Øª
- âœ… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù„Ø§Ú¯ Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¯Ø§Ø±ÛŒØ¯
- âœ… Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± cron Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
- âœ… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø®Ø·Ø§ÛŒØ§Ø¨ÛŒ Ø±Ø§Ø­Øªâ€ŒØªØ± Ø¯Ø§Ø±ÛŒØ¯

**ØªÙˆØµÛŒÙ‡:** Ù†Ø³Ø®Ù‡ 2.0 Ø¨Ø±Ø§ÛŒ **99% Ù…ÙˆØ§Ø±Ø¯** Ø¨Ù‡ØªØ± Ø§Ø³Øª

---

## ğŸ” Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ

### Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ:
```bash
chmod +x IranServerDockerMirror.sh  # 755 - Ø®ÙˆØ¨
```

### Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯:
```bash
# Ø¨Ø±Ø±Ø³ÛŒ root
if [[ $EUID -ne 0 ]]; then exit 1; fi

# Validation
jq . daemon.json >/dev/null 2>&1 || restore_backup

# Cleanup
trap cleanup EXIT
```

---

## ğŸ“ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ

### Ù…Ø´Ú©Ù„ 1: "No mirrors passed /v2 check"

**Ø¹Ù„Øª:** Ù‡Ù…Ù‡ Ù…ÛŒØ±ÙˆØ±Ù‡Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³ØªÙ†Ø¯

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
```bash
# Ø§ÙØ²Ø§ÛŒØ´ timeout
V2_TIMEOUT=10

# ÛŒØ§ ØªØ³Øª Ø¯Ø³ØªÛŒ
curl -I https://focker.ir/v2/
```

### Ù…Ø´Ú©Ù„ 2: "Failed to restart Docker"

**Ø¹Ù„Øª:** Docker daemon Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
```bash
# Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯
journalctl -u docker -n 50

# Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„
systemctl stop docker
systemctl start docker
```

### Ù…Ø´Ú©Ù„ 3: Pull Ù‡Ù…Ú†Ù†Ø§Ù† Ú©Ù†Ø¯ Ø§Ø³Øª

**Ø¹Ù„Øª:** ISP Ø´Ù…Ø§ DNS Ø±Ø§ ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
```bash
# ØªÙ†Ø¸ÛŒÙ… DNS Ø¯Ø± daemon.json
{
  "registry-mirrors": [...],
  "dns": ["178.22.122.100", "185.51.200.2"]
}
```

---

## ğŸ“ˆ Ø¨Ù†Ú†Ù…Ø§Ø±Ú© ÙˆØ§Ù‚Ø¹ÛŒ

### ØªØ³Øª Ø´Ø¯Ù‡ Ø±ÙˆÛŒ:
- Ubuntu 22.04 LTS
- Docker 24.0.7
- RAM: 2GB
- Network: ADSL 8Mbps

### Ù†ØªØ§ÛŒØ¬:

| Ø¹Ù…Ù„ÛŒØ§Øª | Ù‚Ø¨Ù„ÛŒ | Ø¬Ø¯ÛŒØ¯ | Ø¨Ù‡Ø¨ÙˆØ¯ |
|--------|------|------|-------|
| Ù†ØµØ¨ Ø§ÙˆÙ„ÛŒÙ‡ | 2m 45s | 35s | **4.7x** |
| Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ | 2m 30s | 32s | **4.7x** |
| RAM Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ | 15MB | 25MB | -67% |
| CPU Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ | 12% | 35% | -2.9x |

**Ù†ØªÛŒØ¬Ù‡â€ŒÚ¯ÛŒØ±ÛŒ:** Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ CPU Ùˆ RAM Ø¨ÛŒØ´ØªØ±ÛŒ Ù…ØµØ±Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø§Ù…Ø§ **Ø²Ù…Ø§Ù† Ú©Ù„ Ø±Ø§ 75% Ú©Ø§Ù‡Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯**.

---

## ğŸ¯ Ø®Ù„Ø§ØµÙ‡ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§

| ÙˆÛŒÚ˜Ú¯ÛŒ | Ù‚Ø¨Ù„ÛŒ | Ø¬Ø¯ÛŒØ¯ |
|-------|------|------|
| **Ø³Ø±Ø¹Øª** | Ú©Ù†Ø¯ (Ø³Ø±ÛŒØ§Ù„ÛŒ) | âš¡ Ø³Ø±ÛŒØ¹ (Ù…ÙˆØ§Ø²ÛŒ) |
| **Logging** | Ù…Ø­Ø¯ÙˆØ¯ | ğŸ“ Ú©Ø§Ù…Ù„ + ÙØ§ÛŒÙ„ |
| **Ø®Ø·Ø§ÛŒØ§Ø¨ÛŒ** | Ø³Ø®Øª | ğŸ” Ø±Ø§Ø­Øª |
| **UI** | Ø³Ø§Ø¯Ù‡ | ğŸ¨ Ø±Ù†Ú¯ÛŒ Ùˆ Ø²ÛŒØ¨Ø§ |
| **Retry** | Ù†Ø¯Ø§Ø±Ø¯ | âœ… 3 Ø¨Ø§Ø± |
| **Root Check** | Ù†Ø¯Ø§Ø±Ø¯ | âœ… Ø¯Ø§Ø±Ø¯ |
| **Cleanup** | Ø¯Ø³ØªÛŒ | âœ… Ø®ÙˆØ¯Ú©Ø§Ø± |
| **Timeout** | Ú©ÙˆØªØ§Ù‡ | â±ï¸ Ø¨Ù‡ÛŒÙ†Ù‡ |
| **Mirrors** | 14 Ø¹Ø¯Ø¯ | ğŸŒ 18 Ø¹Ø¯Ø¯ |
| **Validation** | Ø³Ø§Ø¯Ù‡ | ğŸ›¡ï¸ Ù¾ÛŒØ´Ø±ÙØªÙ‡ |

---

## ğŸ’¡ ØªÙˆØµÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ

**Ø¨Ø±Ø§ÛŒ Production:** Ø­ØªÙ…Ø§Ù‹ Ù†Ø³Ø®Ù‡ 2.0 Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
**Ø¨Ø±Ø§ÛŒ Testing:** Ù‡Ø± Ø¯Ùˆ Ù†Ø³Ø®Ù‡ Ù‚Ø§Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø³ØªÙ†Ø¯
**Ø¨Ø±Ø§ÛŒ Automation:** ÙÙ‚Ø· Ù†Ø³Ø®Ù‡ 2.0 (logging + retry)

---

## ğŸ“š Ù…Ù†Ø§Ø¨Ø¹ Ø¨ÛŒØ´ØªØ±

- [Docker Registry Mirror Documentation](https://docs.docker.com/registry/recipes/mirror/)
- [Bash Parallel Processing](https://www.gnu.org/software/parallel/)
- [systemd Service Management](https://systemd.io/)

---

**Ù†Ø³Ø®Ù‡:** 2.0  
**ØªØ§Ø±ÛŒØ®:** 2025-01-03  
**Ù†Ú¯Ù‡Ø¯Ø§Ø±Ù†Ø¯Ù‡:** DrConnect Infrastructure Team
