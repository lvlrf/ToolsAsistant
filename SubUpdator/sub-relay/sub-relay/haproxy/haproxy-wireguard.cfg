global
    log /dev/log local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 2000

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Frontend - دریافت ترافیک روی پورت 443
frontend ft_ssl
    bind *:${HAPROXY_FRONTEND_PORT}
    mode tcp
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
    
    # SNI routing - مسیریابی بر اساس SNI
    # اگر SNI برابر با SUB_DOMAIN بود، به backend subscription بفرست
    use_backend bk_sub if { req_ssl_sni -i ${SUB_DOMAIN} }
    
    # اگر SNI برابر با EXISTING_SNI بود، به سرویس فعلی بفرست
    use_backend bk_existing if { req_ssl_sni -i ${EXISTING_SNI} }
    
    # پیش‌فرض: به سرویس فعلی
    default_backend bk_existing

# Backend برای subscription - از طریق تانل WireGuard
backend bk_sub
    mode tcp
    # اتصال به IP سرور در شبکه WireGuard
    server panel ${WG_SERVER_IP}:443 check inter 10s fall 3 rise 2

# Backend برای سرویس فعلی (Xray قدیمی که روی پورت 8443 منتقل شده)
backend bk_existing
    mode tcp
    server existing 127.0.0.1:${EXISTING_SERVICE_PORT} check inter 10s fall 3 rise 2

# آمار HAProxy (اختیاری)
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
